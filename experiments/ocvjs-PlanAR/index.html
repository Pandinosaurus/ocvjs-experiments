<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Hello OpenCV.js</title>
</head>
<body>
<h2>Hello OpenCV.js</h2>
<p id="status">OpenCV.js is loading...</p>
<div>
    <div class="control"><button id="startAndStop">Start</button></div>
</div>
<table cellpadding="0" cellspacing="0" width="0" border="0">
    <tr>
        <td>
            <video id="videoInput" width=320 height=240 hidden></video>
            <img id="reference" src="data/magazine.jpg" hidden/> 
        </td>
        <td>
            <div class="inputoutput">
                <canvas id="canvasReference" ></canvas>
                <div class="caption">Reference </div>
            </div>
        </td>
        <td>
            <div class="inputoutput">
                 <canvas id="canvasFrame" ></canvas>
                 <div class="caption">Frame</div>
            </div>
        </td>
        <td>
            <div class="inputoutput">
                 <canvas id="canvasFrameHidden"></canvas>
                 <div class="caption">FrameHidden</div>
            </div>
        </td>
    <tr>
</table>
<script src="camera.js" type="text/javascript"></script>
<script type="text/javascript">
// Our beautiful canvas and our scene
var canvasReference   = document.getElementById('canvasReference');
var canvasFrame       = document.getElementById('canvasFrame');
var canvasFrameHidden = document.getElementById('canvasFrameHidden');
var scene ; //cv.Mat()


// parallel worker
var worker;
function startWorker() {
    if(typeof(Worker) !== "undefined") {
        if(typeof(worker) == "undefined") {
            worker = new Worker('workerMatching.js');
        }
        worker.addEventListener('message', ({ data }) => {
            if(data.type == 'corners'){
                function drawCornersBoxOnMat(img, corners)
                {
                    //-- Draw lines between the corners
                    var color = new cv.Scalar(125, 255, 0, 255);
                    cv.line(img, 
                            new cv.Point(corners['x0'], 
                                         corners['y0']),
                            new cv.Point(corners['x1'], 
                                         corners['y1']), 
                            color,
                            4 );
                    cv.line(img, 
                            new cv.Point(corners['x1'], 
                                         corners['y1']),
                            new cv.Point(corners['x2'], 
                                         corners['y2']),  
                            color,
                            4 );
                    cv.line(img, 
                            new cv.Point(corners['x2'], 
                                         corners['y2']),
                            new cv.Point(corners['x3'], 
                                         corners['y3']), 
                            color,
                            4 );
                    cv.line(img, 
                            new cv.Point(corners['x3'], 
                                         corners['y3']),
                            new cv.Point(corners['x0'], 
                                         corners['y0']), 
                            color,
                            4 );
                    delete color;
                    return img;
                }
                cv.imshow(canvasFrame, 
                          drawCornersBoxOnMat(scene, data.corners));
                //console.log(data.corners);
            }
        });
    }
}; // startWorker
function stopWorker() { 
    worker.terminate();
    worker = undefined;
}; //stopWorker


// Button to start and stop the video
var camera = new Camera(document.getElementById('startAndStop'), 
                        document.getElementById('videoInput'));
camera.startStopButton.addEventListener('click', () => {
    if (!camera.streaming) {
        camera.startCamera('qvga');
        startWorker();
        process();
    } else {
        camera.stopCamera();
        stopWorker();
    }
});

// Process the images captured with the video
let init = false;
function process(){
  if(camera.streaming){
      if(!init){
          cv.imshow(canvasReference, 
                    cv.imread('reference'));         
          init = true;
      }    
      const referenceData = canvasReference.getContext('2d').getImageData(0,
                                                                          0,
                                                                          canvasReference.width,
                                                                          canvasReference.height);
  
      worker.postMessage({ type: 'reference', referenceData },
                         [ referenceData.data.buffer ]);

      // to replace because quite inefficient
      const ctx = canvasFrameHidden.getContext('2d');
      ctx.drawImage(camera.video, 
                    0, 
                    0, 
                    canvasFrameHidden.width, 
                    canvasFrameHidden.height);
      const frameData = ctx.getImageData(0, 
                                         0, 
                                         canvasFrameHidden.width, 
                                         canvasFrameHidden.height);
       scene = cv.matFromImageData(frameData);
       worker.postMessage({ type: 'frame',  frameData }, 
                          [ frameData.data.buffer ]);
  }
  setTimeout(process, 
             1000/60);
}

function onOpenCvReady() {
  document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
}
</script>
<script src="imgobject.js" type="text/javascript"></script>
<script src="imgobjectmatcher.js" type="text/javascript"></script>
<script async src="opencv/opencv.js"  onload="onOpenCvReady();" type="text/javascript"></script>
</body>
</html>
